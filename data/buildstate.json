{
  "_scf_header": {
    "framework": "Session Continuity Framework",
    "repository": "https://github.com/mariov96/session-continuity-framework",
    "creator": "Mario Vaccari",
    "description": "This file uses Session Continuity Framework to maintain perfect context across AI sessions. SCF transforms AI from order-taker to informed project partner."
  },
  "meta": {
    "spec": "v0.1-technical",
    "companion": "buildstate.md v0.1-strategic",
    "repo": "new-project",
    "purpose": "Technical implementation, debugging, feature development",
    "last_sync": "2025-11-18T00:05:00Z",
    "rebalance_trigger": "major_feature_completion | arch_change | performance_milestone"
  },
  "project": {
    "name": "Scribe - The Open Voice Platform",
    "version": "2.1.0",
    "versioning": {
      "scheme": "Semantic Versioning (MAJOR.MINOR.PATCH)",
      "rules": {
        "major": "Breaking changes, major architecture rewrites, API incompatibility",
        "minor": "New features, significant enhancements, backward-compatible additions",
        "patch": "Bug fixes, small improvements, documentation updates, performance tweaks"
      },
      "examples": {
        "major": "3.0.0 - Complete UI framework change, plugin API v2",
        "minor": "2.1.0 - Add video transcription, new AI model support",
        "patch": "2.0.1 - Fix hotkey bug, improve recording quality"
      },
      "current_increment": "minor",
      "next_planned": "2.1.1 - Polish UX, minor fixes"
    },
    "type": "Desktop Application - Voice Dictation",
    "stakeholder": "Open Source Community",
    "phase": "public_release"
  },
  "current_state": {
    "implemented": [
      "Home first-paint relayout to remove ghosting",
      "Quick Actions duplication removed; simplified single-row buttons",
      "System tray action toggles Start/Stop dynamically",
      "Home Start button toggles to Stop while recording",
      "Hotkey press stops recording if already active (global toggle)",
      "Paste-at-caret fix: removed caret-moving logic from smart formatting",
      "Robust audio error handling to prevent silent crashes"
    ],
    "in_progress": [
      "UI polish and consistency across pages"
    ],
    "blocked": [],
    "performance_metrics": {}
  },
  "bugs": [
    {
      "id": "BUG-001",
      "severity": "critical",
      "title": "Hotkey Recording Crash - Qt Threading Issue",
      "status": "FIXED - user verified working",
      "discovered": "2025-11-17",
      "resolved": "2025-11-17",
      "description": "App crashes/hangs immediately when hotkey pressed to start recording. Process enters stopped state (SIGSTOP) without Python exception.",
      "symptoms": [
        "Hotkey detected successfully by keyboard library",
        "Qt signal emitted and slot called correctly",
        "Log shows '▶️ Starting recording...' then immediate crash/hang",
        "Process status becomes 'T' (stopped/traced), not crashed",
        "No Python traceback - suggests native code deadlock or Qt issue"
      ],
      "investigation_summary": {
        "root_cause_hypothesis": "Qt threading deadlock in UI update code called from hotkey signal handler",
        "evidence": [
          "Crash occurs after 'Starting recording...' logged at line 310 in app.py",
          "Crash happens BEFORE audio_recorder.start_recording() is called",
          "Crash is during main_window.update_recording_status(True) at line 317",
          "Hotkey handler runs via Qt.QueuedConnection from keyboard library thread",
          "UI update methods may not be safe to call from queued cross-thread signal"
        ],
        "fixes_attempted": [
          {
            "attempt": "Fixed audio callback Qt threading (removed signal emission from PortAudio thread)",
            "result": "Fixed original crash, but revealed new UI threading issue",
            "commit": "3efa366"
          },
          {
            "attempt": "Added callback wrapper to isolate audio thread",
            "result": "No change - crash still occurs before audio code runs"
          },
          {
            "attempt": "Changed latency parameter from 'low' to None",
            "result": "No change - not related to audio configuration"
          },
          {
            "attempt": "Used QTimer.singleShot to defer audio start to next event loop",
            "result": "No change - crash happens before deferred call executes"
          },
          {
            "attempt": "Removed debug logging that might cause I/O blocking",
            "result": "No change - logging not the issue"
          }
        ],
        "what_works": [
          "App startup and initialization",
          "Hotkey detection via keyboard library",
          "Signal/slot connections with Qt.QueuedConnection",
          "All 49 unit tests pass (including integration tests with real hardware)",
          "Audio recorder thread safety fixes validated"
        ],
        "what_fails": [
          "Any attempt to call main_window.update_recording_status() from hotkey handler",
          "Process deadlocks/stops instead of crashing with exception",
          "UI becomes unresponsive (suggests Qt event loop blocked)"
        ]
      },
      "solution_implemented": {
        "root_cause": "Synchronous UI method calls in hotkey handler causing re-entrancy and deadlock, plus Unicode encoding errors on Windows console",
        "fix_approach": "Signal-based decoupling + QTimer deferral + Unicode fixes",
        "changes_made": [
          "Added recording_status_changed and hotkey_status_changed signals to ScribeApp",
          "Modified _on_hotkey_down() to emit hotkey_status_changed signal instead of calling main_window.update_hotkey_status()",
          "Modified _on_hotkey_down() to use QTimer.singleShot(0) to defer _start_recording() call completely",
          "Modified _start_recording() to emit recording_status_changed signal instead of calling main_window.update_recording_status()",
          "Modified _stop_recording() to emit recording_status_changed signal",
          "Connected signals to UI methods with Qt.QueuedConnection in _connect_ui_signals()",
          "Removed all emoji characters from print() statements to fix Windows cp1252 encoding errors",
          "Added global exception handler (_global_exception_handler) to catch unhandled exceptions",
          "Removed unused _do_start_recording() method from previous fix attempt"
        ],
        "how_it_works": [
          "Hotkey press → emit signal (non-blocking) → QTimer.singleShot(0) defers _start_recording() → return immediately",
          "Qt event loop queues both signal delivery and deferred call to main thread",
          "UI update methods execute asynchronously when event loop processes queue",
          "Recording starts via deferred call, completely breaking any synchronous chain",
          "No synchronous call chain = no deadlock, no re-entrancy issues",
          "Unicode-safe print statements prevent Windows console encoding crashes"
        ],
        "files_modified": [
          "src/scribe/app.py - Added signals, modified hotkey and recording methods",
          "tests/test_hotkey_threading.py - Comprehensive unit tests (11 tests created)"
        ],
        "tests_created": [
          "test_hotkey_emits_signal_not_direct_call - PASSED",
          "test_recording_start_emits_signal_not_direct_call - PASSED",
          "test_recording_stop_emits_signal_not_direct_call",
          "test_signal_connection_uses_queued_connection",
          "test_hotkey_to_recording_flow_no_blocking",
          "test_error_during_recording_emits_signal",
          "test_concurrent_hotkey_presses_dont_deadlock",
          "test_thread_safety_main_thread_check",
          "test_recording_widget_updates_asynchronously"
        ]
      },
      "affected_files": [
        "src/scribe/app.py (line 317 - UI update call)",
        "src/scribe/core/hotkey_manager.py (signal emission from keyboard thread)",
        "src/scribe/ui_fluent/main_window.py (update_recording_status method)",
        "src/scribe/ui_fluent/widgets/recording_widget.py (start_recording method)"
      ],
      "workaround": "Fixed - no workaround needed",
      "user_verification": {
        "tested_by": "User",
        "test_date": "2025-11-17",
        "test_results": "Complete success - multiple recording cycles tested",
        "test_notes": [
          "Hotkey (Ctrl+Alt) triggers recording start successfully",
          "Recording stops on hotkey release",
          "Transcription completes: 'Can you hear me?' transcribed correctly",
          "Text copied to clipboard automatically",
          "Multiple cycles tested - all working perfectly",
          "No crashes, no hangs, no deadlocks"
        ]
      },
      "technical_notes": {
        "qt_threading_rules": [
          "Qt UI methods MUST be called from main/GUI thread only",
          "QueuedConnection should defer to main thread but may not be sufficient",
          "Qt objects created in one thread cannot safely call methods from another",
          "Some Qt widgets have internal DirectConnection signals that bypass queuing"
        ],
        "keyboard_library_behavior": "Global hotkey callbacks run in separate thread created by keyboard library, NOT Qt thread",
        "process_stopped_state": "SIGSTOP signal suggests debugger-like pause, possibly Qt's deadlock detection or thread waiting on mutex"
      },
      "priority": "P0 - Blocks all recording functionality",
      "impact": "Complete loss of core feature - users cannot record audio via hotkey"
    }
  ],
  "tech_stack": {
    "frontend": [],
    "backend": [],
    "database": [],
    "deployment": [],
    "testing": []
  },
  "architecture": {
    "components": [],
    "services": [],
    "data_flow": "",
    "state_management": "",
    "error_strategy": ""
  },
  "requirements": {
    "functional": [],
    "non_functional": [],
    "constraints": [],
    "assumptions": []
  },
  "user_stories": [],
  "acceptance_criteria": [],
  "next_immediate": [],
  "development": {
    "env_vars": [],
    "commands": {},
    "setup_notes": []
  },
  "performance": {
    "requirements": [],
    "constraints": [],
    "targets": []
  },
  "coding_standards": {
    "languages": [],
    "frameworks": [],
    "patterns": [],
    "conventions": {}
  },
  "session_log": [
    {
      "date": "2025-11-18",
      "type": "feature_and_stability",
      "changes": [
        "Home: fixed first-paint rendering (forced relayout/repaint via QTimer and showEvent)",
        "Home: removed duplicate 'Quick Actions' header; simplified actions to buttons",
        "Tray: Start/Stop now toggles with UI state",
        "Hotkey: pressing while recording now stops immediately (works regardless of source)",
        "Home: Start button toggles to Stop during active recording",
        "Text insertion: removed cursor-moving in smart formatting to paste exactly at caret",
        "Audio: added defensive error handling around stream lifecycle to prevent crashes"
      ],
      "notes": "User verified visual fixes and behavior. Focus shifted from neon redesign to clean, stable UI."
    },
    {
      "date": "2025-11-17",
      "type": "critical_bug_fix_complete",
      "changes": [
        "FIXED BUG-001: Qt threading deadlock in hotkey recording",
        "Implemented QTimer.singleShot(0) to defer _start_recording() execution completely",
        "Added recording_status_changed and hotkey_status_changed Qt signals",
        "Connected all UI updates via Qt.QueuedConnection for thread safety",
        "Fixed Unicode encoding errors (removed emoji characters from print statements)",
        "Added global exception handler to catch unhandled exceptions",
        "User verified: Multiple successful recording/transcription cycles",
        "Transcription test: 'Can you hear me?' - 100% accurate"
      ],
      "notes": "After hours of debugging with Copilot Sonnet 4.5, user requested comprehensive fix with proper testing. Implemented signal-based architecture + QTimer deferral to eliminate all synchronous call chains. Also fixed secondary Unicode encoding issue on Windows. Complete success - ended the debugging cycle with working app."
    },
    {
      "date": "2025-11-17",
      "type": "critical_bug_investigation",
      "changes": [
        "Fixed Qt thread safety in audio_recorder.py (removed signal emission from PortAudio callback)",
        "Added QTimer-based cross-thread signal emission (50ms intervals)",
        "Fixed PyQt5/PySide6 mixing issue (reverted all to PyQt5)",
        "Fixed Qt.QueuedConnection syntax for PyQt5 (type= keyword argument)",
        "Created comprehensive test suite (49 tests, all passing)",
        "Added detailed logging to trace crash point",
        "Identified new Qt threading issue in UI update code"
      ],
      "notes": "Started with silent crash on recording. Fixed audio thread safety but uncovered deeper Qt UI threading issue. Hotkey works but UI update causes deadlock. Multiple fix attempts unsuccessful. Need different architectural approach."
    },
    {
      "date": "2025-11-13",
      "type": "ux_improvements",
      "changes": [
        "Implemented timestamped log files with auto-rotation",
        "Fixed language change incorrectly triggering model reload",
        "Enhanced model loading feedback (cached vs downloading)",
        "Improved Insights page with Session Activity card",
        "Updated Settings log viewer to show current file"
      ],
      "notes": "Quality of life improvements completed before critical crash was discovered"
    },
    {
      "date": "2025-01-19",
      "type": "initialization",
      "changes": [
        "created_fresh_buildstate_system"
      ],
      "notes": "established dual-file architecture for new project ideation"
    }
  ],
  "ai_context": {
    "conversation_tracking": true,
    "capacity_monitoring": true,
    "alert_threshold": "80%",
    "rebalance_suggestions": "automated_on_triggers",
    "sync_automation": "sync_buildstate.py framework ready",
    "scf_commands": {
      "time": "Intelligent token usage estimate with capacity warnings",
      "rules": "List active rules and behavioral guidelines",
      "closeout": "Provide updated buildstate file for session end"
    }
  }
}